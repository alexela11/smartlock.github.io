<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Drawer Staff Registration</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-4">Staff Registration</h1>

  <form id="register-form" class="space-y-4">

    <!-- Staff Name -->
    <div>
      <label class="block mb-1 font-semibold">Name</label>
      <input type="text" id="name" placeholder="Full Name" class="w-full p-2 border rounded" required>
    </div>

    <!-- Staff ID -->
    <div>
      <label class="block mb-1 font-semibold">Staff ID</label>
      <input type="text" id="staff-id" placeholder="Enter Staff ID" class="w-full p-2 border rounded" required>
    </div>

    <!-- RFID Dropdown -->
    <div>
      <label class="block mb-1 font-semibold">RFID UID</label>
      <select id="rfid-uid" class="w-full p-2 border rounded" required>
        <option value="">Loading RFID UIDs...</option>
      </select>
    </div>

    <!-- Fingerprint UID (temporary for now) -->
    <div>
      <label class="block mb-1 font-semibold">Fingerprint UID</label>
      <input type="text" id="fingerprint-uid" placeholder="Enter Fingerprint UID" class="w-full p-2 border rounded" required>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Register Staff</button>
    <p id="status" class="mt-2 text-gray-700"></p>
  </form>
</div>

<script>
  // -----------------------------
  // Supabase config
  // -----------------------------
  const SUPABASE_URL = "https://rdmhulunpoxffpzwzqcf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkbWh1bHVucG94ZmZwend6cWNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODEzNzYsImV4cCI6MjA4NDM1NzM3Nn0.WW1Z3IpmPDolDGdcpYrLfdy2ug2dAVyzNXEMvhUqKZU"; // anon key
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // -----------------------------
  // Load RFID UIDs from database
  // -----------------------------
  async function loadRFIDs() {
    const { data, error } = await supabase
      .from('rfid_cards')   // Table where RFID UIDs are stored
      .select('uid');

    const rfidSelect = document.getElementById('rfid-uid');
    rfidSelect.innerHTML = '<option value="">Select RFID</option>'; // reset

    if(data){
      data.forEach(rfid => {
        const option = document.createElement('option');
        option.value = rfid.uid;
        option.textContent = rfid.uid;
        rfidSelect.appendChild(option);
      });
    } else {
      rfidSelect.innerHTML = '<option value="">Error loading RFID</option>';
      console.log('Error loading RFID UIDs:', error);
    }
  }

  loadRFIDs();

  // -----------------------------
  // Handle form submission
  // -----------------------------
  const form = document.getElementById('register-form');
  const status = document.getElementById('status');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.innerText = "Registering staff...";

    const name = document.getElementById('name').value.trim();
    const staffId = document.getElementById('staff-id').value.trim();
    const rfid_uid = document.getElementById('rfid-uid').value;
    const fingerprint_uid = document.getElementById('fingerprint-uid').value.trim();

    if(!name || !staffId || !rfid_uid || !fingerprint_uid){
      status.innerText = "Please fill all fields.";
      return;
    }

    try {
      const { data, error } = await supabase.from('users').insert([{
        name,
        staff_id: staffId,
        role: 'staff',
        fingerprint_id: fingerprint_uid,
        rfid_uid
      }]);

      if(error){
        status.innerText = "Error: " + error.message;
      } else {
        status.innerText = "Staff registered successfully!";
        form.reset();
      }
    } catch(err){
      status.innerText = "Unexpected error: " + err.message;
      console.log(err);
    }
  });
</script>

</body>
</html>
