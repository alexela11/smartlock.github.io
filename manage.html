<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users</title>

  <link rel="stylesheet" href="stalk.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- TOP BAR -->
  <div class="top-bar">
    <a href="index.html" class="btn secondary">‚¨Ö Back</a>
    <a href="register.html" class="btn primary">‚ûï Register User</a>
  </div>

  <h2>Registered Users</h2>

  <!-- TABLE -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Staff ID</th>
          <th>RFID</th>
          <th>Fingerprint</th>
          <th>Registered At</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="userTable">
        <tr>
          <td colspan="6">Loading users...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- MODAL 1 -->
  <div id="modalStep1" class="modal hidden">
    <div class="modal-box">
      <p>Do you want to delete this user?</p>
      <div class="modal-actions">
        <button class="btn danger" onclick="goStep2()">Yes</button>
        <button class="btn secondary" onclick="closeModal()">No</button>
      </div>
    </div>
  </div>

  <!-- MODAL 2 -->
  <div id="modalStep2" class="modal hidden">
    <div class="modal-box">
      <p><strong>Are you sure?</strong></p>
      <div class="modal-actions">
        <button class="btn danger" onclick="deleteUser()">Confirm</button>
        <button class="btn secondary" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== SUPABASE CONFIG ===== */
    const SUPABASE_URL = "https://wevvbzauprknjkoozshp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldnZiemF1cHJrbmprb296c2hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTMwMDksImV4cCI6MjA4NDM4OTAwOX0.z1fjSoD9a3rCpGQTaDKazc2LBB3Cti46jMD1uAhGgsY";

    const supabaseClient = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    let selectedUserId = null;

    /* ===== LOAD USERS ===== */
    async function loadUsers() {
      const { data, error } = await supabaseClient
        .from("users")
        .select("*")
        .order("created_at", { ascending: false });

      const table = document.getElementById("userTable");
      table.innerHTML = "";

      if (error || data.length === 0) {
        table.innerHTML = `
          <tr>
            <td colspan="6">No users found</td>
          </tr>
        `;
        return;
      }

      data.forEach(user => {
        table.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.staff_id}</td>
            <td class="center">${user.rfid_uid ? "‚úî" : "‚úñ"}</td>
            <td class="center">${user.fingerprint_id ? "‚úî" : "‚úñ"}</td>
            <td>${new Date(user.created_at).toLocaleString()}</td>
            <td class="center">
              <button class="delete-btn" onclick="openDelete('${user.id}')">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `;
      });
    }

    loadUsers();

    /* ===== DELETE FLOW ===== */
    function openDelete(userId) {
      selectedUserId = userId;
      document.getElementById("modalStep1").classList.remove("hidden");
    }

    function goStep2() {
      document.getElementById("modalStep1").classList.add("hidden");
      document.getElementById("modalStep2").classList.remove("hidden");
    }

    function closeModal() {
      selectedUserId = null;
      document.getElementById("modalStep1").classList.add("hidden");
      document.getElementById("modalStep2").classList.add("hidden");
    }

    async function deleteUser() {
      if (!selectedUserId) return;

      await supabaseClient
        .from("users")
        .delete()
        .eq("id", selectedUserId);

      closeModal();
      loadUsers();
    }
  </script>

</body>
</html>
